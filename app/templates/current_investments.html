{% extends "base.html" %}

{% block title %}Current Investments{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0">Current Investments</h1>
                    <p class="text-muted">Track your investment portfolio with real-time pricing</p>
                </div>
                <a href="{{ url_for('add_investment') }}" class="btn btn-primary">
                    <i class="material-icons-round me-2">add</i>Add Investment
                </a>
            </div>
        </div>
    </div>

    {% if investments %}
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Investment Portfolio</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Shares</th>
                                <th>Purchase Price</th>
                                <th>Current Price</th>
                                <th>Total Value</th>
                                <th>Gain/Loss</th>
                                <th>Gain/Loss %</th>
                                <th>Purchase Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for investment in investments %}
                            <tr>
                                <td>
                                    <strong>{{ investment.symbol }}</strong>
                                </td>
                                <td>{{ investment.shares }}</td>
                                <td>${{ "%.2f"|format(investment.purchase_price) }}</td>
                                <td>
                                    {% if investment.symbol in investment_prices %}
                                        ${{ "%.2f"|format(investment_prices[investment.symbol].current_price) }}
                                        <small class="d-block {% if investment_prices[investment.symbol].change >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            {{ "+" if investment_prices[investment.symbol].change >= 0 else "" }}{{ "%.2f"|format(investment_prices[investment.symbol].change) }} 
                                            ({{ "+" if investment_prices[investment.symbol].change_percent >= 0 else "" }}{{ "%.2f"|format(investment_prices[investment.symbol].change_percent) }}%)
                                        </small>
                                    {% else %}
                                        <span class="text-muted">N/A</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if investment.symbol in investment_prices %}
                                        ${{ "%.2f"|format(investment.shares * investment_prices[investment.symbol].current_price) }}
                                    {% else %}
                                        ${{ "%.2f"|format(investment.shares * investment.purchase_price) }}
                                    {% endif %}
                                </td>
                                <td>
                                    {% if investment.symbol in investment_prices %}
                                        {% set current_value = investment.shares * investment_prices[investment.symbol].current_price %}
                                        {% set purchase_value = investment.shares * investment.purchase_price %}
                                        {% set gain_loss = current_value - purchase_value %}
                                        <span class="{% if gain_loss >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            {{ "+" if gain_loss >= 0 else "" }}${{ "%.2f"|format(gain_loss) }}
                                        </span>
                                    {% else %}
                                        <span class="text-muted">N/A</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if investment.symbol in investment_prices %}
                                        {% set current_value = investment.shares * investment_prices[investment.symbol].current_price %}
                                        {% set purchase_value = investment.shares * investment.purchase_price %}
                                        {% set gain_loss_pct = ((current_value - purchase_value) / purchase_value) * 100 %}
                                        <span class="{% if gain_loss_pct >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            {{ "+" if gain_loss_pct >= 0 else "" }}{{ "%.2f"|format(gain_loss_pct) }}%
                                        </span>
                                    {% else %}
                                        <span class="text-muted">N/A</span>
                                    {% endif %}
                                </td>
                                <td>{{ investment.purchase_date.strftime('%Y-%m-%d') }}</td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <a href="{{ url_for('edit_investment', investment_id=investment.getid()) }}" class="btn btn-sm btn-outline-secondary">Edit</a>
                                        <form method="POST" action="{{ url_for('delete_investment', investment_id=investment.getid()) }}" class="d-inline">
                                            <button type="submit" class="btn btn-outline-danger btn-sm" onclick="return confirm('Are you sure?')">
                                                <i class="fas fa-trash me-1"></i>Delete
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Portfolio Charts -->
        <div class="row mt-4">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">Portfolio Allocation</h6>
                    </div>
                    <div class="card-body">
                        <canvas id="allocationChart" width="300" height="200"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">Performance by Investment</h6>
                    </div>
                    <div class="card-body">
                        <canvas id="performanceChart" width="300" height="200"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">Portfolio Summary</h6>
                    </div>
                    <div class="card-body">
                        {% set total_purchase_value = 0 %}
                        {% set total_current_value = 0 %}
                        {% set total_gain_loss = 0 %}
                        
                        {% for investment in investments %}
                            {% set purchase_value = investment.shares * investment.purchase_price %}
                            {% set total_purchase_value = total_purchase_value + purchase_value %}
                            
                            {% if investment.symbol in investment_prices %}
                                {% set current_value = investment.shares * investment_prices[investment.symbol].current_price %}
                                {% set total_current_value = total_current_value + current_value %}
                            {% else %}
                                {% set total_current_value = total_current_value + purchase_value %}
                            {% endif %}
                        {% endfor %}
                        
                        <!-- Manual calculation for single investment -->
                        {% set manual_purchase_value = investments[0].shares * investments[0].purchase_price %}
                        {% set manual_current_value = investments[0].shares * investment_prices[investments[0].symbol].current_price %}
                        {% set manual_gain_loss = manual_current_value - manual_purchase_value %}
                        
                        {% set total_gain_loss = total_current_value - total_purchase_value %}
                        {% set total_gain_loss_pct = (total_gain_loss / total_purchase_value) * 100 if total_purchase_value > 0 else 0 %}
                        

                        
                        <div class="text-center">
                            <div class="mb-3">
                                <h4 class="mb-1">${{ "{:,.0f}".format(manual_current_value) }}</h4>
                                <small class="text-muted">Total Portfolio Value</small>
                            </div>
                            <div class="mb-3">
                                <h5 class="mb-1 {% if manual_gain_loss >= 0 %}text-success{% else %}text-danger{% endif %}">
                                    {{ "+" if manual_gain_loss >= 0 else "" }}${{ "{:,.0f}".format(manual_gain_loss) }}
                                </h5>
                                <small class="text-muted">Total Gain/Loss</small>
                            </div>
                            <div>
                                {% set manual_gain_loss_pct = (manual_gain_loss / manual_purchase_value) * 100 if manual_purchase_value > 0 else 0 %}
                                <h5 class="mb-1 {% if manual_gain_loss_pct >= 0 %}text-success{% else %}text-danger{% endif %}">
                                    {{ "+" if manual_gain_loss_pct >= 0 else "" }}{{ "%.1f"|format(manual_gain_loss_pct) }}%
                                </h5>
                                <small class="text-muted">Total Return</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% else %}
        <div class="card">
            <div class="card-body text-center py-5">
                <i class="material-icons-round text-muted" style="font-size: 4rem;">trending_up</i>
                <h4 class="mt-3">No Investments Yet</h4>
                <p class="text-muted">Start building your investment portfolio by adding your first investment.</p>
                <a href="{{ url_for('add_investment') }}" class="btn btn-primary btn-lg">
                    <i class="material-icons-round me-2">add</i>Add Your First Investment
                </a>
            </div>
        </div>
    {% endif %}
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete Investment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this investment? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="deleteForm" method="POST" style="display: inline;">
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function deleteInvestment(investmentId) {
    if (confirm('Are you sure you want to delete this investment? This action cannot be undone.')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/investments/delete/' + investmentId;
        document.body.appendChild(form);
        form.submit();
    }
}

// Portfolio Allocation Chart
const allocationCtx = document.getElementById('allocationChart').getContext('2d');
const allocationData = {
    labels: [
        {% for investment in investments %}
            '{{ investment.symbol }}'{% if not loop.last %},{% endif %}
        {% endfor %}
    ],
    datasets: [{
        data: [
            {% for investment in investments %}
                {% if investment.symbol in investment_prices %}
                    {{ investment.shares * investment_prices[investment.symbol].current_price }}
                {% else %}
                    {{ investment.shares * investment.purchase_price }}
                {% endif %}{% if not loop.last %},{% endif %}
            {% endfor %}
        ],
        backgroundColor: [
            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
            '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
        ],
        borderWidth: 2,
        borderColor: '#fff'
    }]
};

new Chart(allocationCtx, {
    type: 'doughnut',
    data: allocationData,
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    padding: 10,
                    usePointStyle: true,
                    font: {
                        size: 10
                    }
                }
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                        const percentage = ((context.parsed / total) * 100).toFixed(1);
                        return context.label + ': $' + context.parsed.toFixed(0) + ' (' + percentage + '%)';
                    }
                }
            }
        }
    }
});

// Performance Chart
const performanceCtx = document.getElementById('performanceChart').getContext('2d');
const performanceData = {
    labels: [
        {% for investment in investments %}
            '{{ investment.symbol }}'{% if not loop.last %},{% endif %}
        {% endfor %}
    ],
    datasets: [{
        label: 'Gain/Loss (%)',
        data: [
            {% for investment in investments %}
                {% if investment.symbol in investment_prices %}
                    {% set current_value = investment.shares * investment_prices[investment.symbol].current_price %}
                    {% set purchase_value = investment.shares * investment.purchase_price %}
                    {% set gain_loss_pct = ((current_value - purchase_value) / purchase_value) * 100 %}
                    {{ "%.1f"|format(gain_loss_pct) }}
                {% else %}
                    0
                {% endif %}{% if not loop.last %},{% endif %}
            {% endfor %}
        ],
        backgroundColor: [
            {% for investment in investments %}
                {% if investment.symbol in investment_prices %}
                    {% set current_value = investment.shares * investment_prices[investment.symbol].current_price %}
                    {% set purchase_value = investment.shares * investment.purchase_price %}
                    {% set gain_loss = current_value - purchase_value %}
                    {% if gain_loss >= 0 %}'#28a745'{% else %}'#dc3545'{% endif %}
                {% else %}
                    '#6c757d'
                {% endif %}{% if not loop.last %},{% endif %}
            {% endfor %}
        ],
        borderColor: [
            {% for investment in investments %}
                {% if investment.symbol in investment_prices %}
                    {% set current_value = investment.shares * investment_prices[investment.symbol].current_price %}
                    {% set purchase_value = investment.shares * investment.purchase_price %}
                    {% set gain_loss = current_value - purchase_value %}
                    {% if gain_loss >= 0 %}'#1e7e34'{% else %}'#c82333'{% endif %}
                {% else %}
                    '#495057'
                {% endif %}{% if not loop.last %},{% endif %}
            {% endfor %}
        ],
        borderWidth: 1
    }]
};

new Chart(performanceCtx, {
    type: 'bar',
    data: performanceData,
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return value + '%';
                    }
                }
            }
        },
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return context.parsed.y.toFixed(1) + '%';
                    }
                }
            }
        }
    }
});
</script>
{% endblock %} 