{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h2 mb-2">Asset Allocation</h1>
                    <p class="text-muted">Manage your retirement portfolio asset allocation</p>
                </div>
                <a href="{{ url_for('add_asset') }}" class="btn btn-success">
                    <i class="material-icons-round">add</i> Add Asset
                </a>
            </div>
        </div>
    </div>

    {% if assets %}
        <!-- Portfolio Summary -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Portfolio Summary</h5>
                    </div>
                    <div class="card-body">
                        {% set total_weight = 0 %}
                        {% set weighted_return = 0 %}
                        
                        {% for asset in assets %}
                            {% set total_weight = total_weight + asset.weight %}
                            {% set weighted_return = weighted_return + (asset.expected_return * asset.weight / 100) %}
                        {% endfor %}
                        
                        <div class="row">
                            <div class="col-md-3">
                                <h6 class="text-muted">Total Assets</h6>
                                <h4>{{ assets|length }}</h4>
                            </div>
                            <div class="col-md-3">
                                <h6 class="text-muted">Total Weight</h6>
                                <h4 class="{% if total_weight == 100 %}text-success{% elif total_weight > 100 %}text-danger{% else %}text-warning{% endif %}">
                                    {{ "%.1f"|format(total_weight) }}%
                                </h4>
                            </div>
                            <div class="col-md-3">
                                <h6 class="text-muted">Weighted Return</h6>
                                <h4>{{ "%.1f"|format(weighted_return) }}%</h4>
                            </div>
                            <div class="col-md-3">
                                <h6 class="text-muted">Risk Level</h6>
                                <h4>
                                    {% set risk_counts = {'Low': 0, 'Medium': 0, 'High': 0} %}
                                    {% for asset in assets %}
                                        {% set _ = risk_counts.update({asset.risk_level: risk_counts[asset.risk_level] + 1}) %}
                                    {% endfor %}
                                    {% if risk_counts['High'] > risk_counts['Low'] and risk_counts['High'] > risk_counts['Medium'] %}
                                        <span class="text-danger">High</span>
                                    {% elif risk_counts['Medium'] > risk_counts['Low'] %}
                                        <span class="text-warning">Medium</span>
                                    {% else %}
                                        <span class="text-success">Low</span>
                                    {% endif %}
                                </h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Allocation Visualization -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="material-icons-round text-warning me-2">pie_chart</i> Allocation Breakdown</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="d-flex flex-wrap">
                                    {% for asset in assets %}
                                    <div class="me-4 mb-3">
                                        <div class="d-flex align-items-center">
                                            <div class="rounded-circle me-2" style="width: 20px; height: 20px; background-color: 
                                                {% if loop.index0 == 0 %}#7fb069
                                                {% elif loop.index0 == 1 %}#f4a261
                                                {% elif loop.index0 == 2 %}#e76f51
                                                {% elif loop.index0 == 3 %}#264653
                                                {% elif loop.index0 == 4 %}#2a9d8f
                                                {% elif loop.index0 == 5 %}#e9c46a
                                                {% else %}#6c757d{% endif %};"></div>
                                            <span class="fw-bold">{{ asset.symbol }}</span>
                                            <span class="text-muted ms-2">{{ "%.1f"|format(asset.weight) }}%</span>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                <div class="mt-3">
                                    <div class="progress" style="height: 30px;">
                                        {% set colors = ['#7fb069', '#f4a261', '#e76f51', '#264653', '#2a9d8f', '#e9c46a', '#6c757d'] %}
                                        {% set current_position = 0 %}
                                        {% for asset in assets %}
                                            <div class="progress-bar" role="progressbar" 
                                                 style="width: {{ asset.weight }}%; background-color: {{ colors[loop.index0 % colors|length] }};"
                                                 title="{{ asset.symbol }}: {{ "%.1f"|format(asset.weight) }}%">
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <h6 class="text-muted mb-3">Risk Distribution</h6>
                                {% set risk_counts = {'Low': 0, 'Medium': 0, 'High': 0} %}
                                {% for asset in assets %}
                                    {% set _ = risk_counts.update({asset.risk_level: risk_counts[asset.risk_level] + 1}) %}
                                {% endfor %}
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between">
                                        <span>Low Risk</span>
                                        <span class="fw-bold text-success">{{ risk_counts['Low'] }}</span>
                                    </div>
                                    <div class="progress" style="height: 8px;">
                                        {% set total_assets = assets|length %}
                                        <div class="progress-bar bg-success" style="width: {{ (risk_counts['Low'] / total_assets) * 100 }}%"></div>
                                    </div>
                                </div>
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between">
                                        <span>Medium Risk</span>
                                        <span class="fw-bold text-warning">{{ risk_counts['Medium'] }}</span>
                                    </div>
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar bg-warning" style="width: {{ (risk_counts['Medium'] / total_assets) * 100 }}%"></div>
                                    </div>
                                </div>
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between">
                                        <span>High Risk</span>
                                        <span class="fw-bold text-danger">{{ risk_counts['High'] }}</span>
                                    </div>
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar bg-danger" style="width: {{ (risk_counts['High'] / total_assets) * 100 }}%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Assets Table -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Portfolio Assets</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Asset</th>
                                        <th>Type</th>
                                        <th>Weight</th>
                                        <th>Expected Return</th>
                                        <th>Risk Level</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for asset in assets %}
                                    <tr>
                                        <td>
                                            <strong>{{ asset.symbol }}</strong>
                                            <br>
                                            <small class="text-muted">{{ asset.name }}</small>
                                        </td>
                                        <td>{{ asset.asset_type }}</td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="progress flex-grow-1 me-2" style="height: 8px;">
                                                    <div class="progress-bar" role="progressbar" style="width: {{ asset.weight }}%"></div>
                                                </div>
                                                <span class="text-muted">{{ "%.1f"|format(asset.weight) }}%</span>
                                            </div>
                                        </td>
                                        <td>{{ "%.1f"|format(asset.expected_return) }}%</td>
                                        <td>
                                            <span class="badge bg-{% if asset.risk_level == 'Low' %}success{% elif asset.risk_level == 'Medium' %}warning{% else %}danger{% endif %}">
                                                {{ asset.risk_level }}
                                            </span>
                                        </td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <a href="{{ url_for('edit_asset', asset_id=asset.id) }}" class="btn btn-sm btn-outline-primary">Edit</a>
                                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteAsset({{ asset.id }})">Delete</button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% else %}
        <!-- Empty State -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body text-center py-5">
                        <i class="material-icons-round text-muted" style="font-size: 4rem;">pie_chart</i>
                        <h4 class="mt-3">No assets in your portfolio</h4>
                        <p class="text-muted">Start building your retirement portfolio by adding assets</p>
                        <a href="{{ url_for('add_asset') }}" class="btn btn-success btn-lg">
                            <i class="material-icons-round">add</i> Add Your First Asset
                        </a>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete Asset</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this asset? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="deleteForm" method="POST" style="display: inline;">
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function deleteAsset(assetId) {
    const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
    const form = document.getElementById('deleteForm');
    form.action = `/portfolio/allocation/delete/${assetId}`;
    modal.show();
}
</script>
{% endblock %} 